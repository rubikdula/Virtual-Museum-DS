{% extends "base.html" %}

{% block content %}
<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
<div class="container py-5">
    <div class="row">
        <div class="col-md-8">
            {% if artifact.media_type == 'image' %}
                <img src="{{ artifact.media_url }}" class="img-fluid w-100 mb-4" alt="{{ artifact.title }}">
            {% elif artifact.media_type == '3d_model' %}
                <div class="ratio ratio-4x3 mb-4 bg-light border">
                    <model-viewer 
                        src="{{ artifact.media_url }}" 
                        alt="{{ artifact.title }}"
                        auto-rotate 
                        camera-controls 
                        ar
                        shadow-intensity="1"
                        style="width: 100%; height: 100%;"
                        background-color="#f8f9fa">
                    </model-viewer>
                </div>
            {% elif artifact.media_type == 'video_url' %}
                <div class="ratio ratio-16x9 mb-4">
                    <iframe src="{{ artifact.media_url }}" allowfullscreen></iframe>
                </div>
            {% else %}
                <div class="p-5 bg-light text-center mb-4">
                    <a href="{{ artifact.media_url }}" target="_blank" class="btn btn-primary">View {{ artifact.media_type }}</a>
                </div>
            {% endif %}

            <!-- Comments Section -->
            <div class="mt-5">
                <h3 class="fw-bold mb-4">Comments ({{ artifact.comments|length }})</h3>
                
                <!-- Comment Form -->
                {% if user %}
                <form action="/artifacts/{{ artifact.id }}/comment" method="post" class="mb-5">
                    <div class="d-flex gap-3">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed={{ user.username }}" class="rounded-circle border" width="40" height="40">
                        <div class="flex-grow-1">
                            <textarea name="text" class="form-control border-0 border-bottom rounded-0 bg-light p-3" rows="2" placeholder="Add a comment..." required></textarea>
                            <div class="text-end mt-2">
                                <button type="submit" class="btn btn-dark rounded-0 px-4">Post Comment</button>
                            </div>
                        </div>
                    </div>
                </form>
                {% else %}
                <div class="alert alert-light border mb-5">
                    <a href="/login" class="fw-bold text-dark">Login</a> to leave a comment.
                </div>
                {% endif %}

                <!-- Comments List -->
                <div class="d-flex flex-column gap-4">
                    {% for comment in artifact.comments|reverse %}
                    <div class="d-flex gap-3">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed={{ comment.user.username }}" class="rounded-circle border" width="40" height="40">
                        <div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="fw-bold">{{ comment.user.username }}</span>
                                <small class="text-muted">{{ comment.created_at.strftime('%B %d, %Y') }}</small>
                            </div>
                            <p class="mb-0 mt-1">{{ comment.text }}</p>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted">No comments yet. Be the first to share your thoughts!</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4 ps-md-5">
            <div class="sticky-top" style="top: 2rem;">
                <h1 class="display-4 fw-bold mb-3" style="letter-spacing: -2px;">{{ artifact.title }}</h1>
                
                <div class="mb-4">
                    {% if "AI Generated" in (artifact.tags or "") %}
                        <span class="badge bg-warning text-dark me-2 shadow-sm">âœ¨ AI Generated</span>
                    {% endif %}
                    <span class="text-uppercase fw-bold text-muted">{{ artifact.category }}</span>
                    {% if artifact.year %}
                        <span class="text-muted mx-2">|</span>
                        <span class="fw-bold">{{ artifact.year }}</span>
                    {% endif %}
                </div>

                <p class="lead mb-4">{{ artifact.short_description }}</p>
                
                <div class="mb-5">
                    {{ artifact.long_description or artifact.short_description }}
                </div>

                <div class="d-grid gap-2">
                    <form action="/artifacts/{{ artifact.id }}/like" method="post">
                        {% if is_liked %}
                            <button type="submit" class="btn btn-outline-dark w-100 btn-lg rounded-0 text-uppercase fw-bold">
                                Unlike ({{ artifact.likes_count }})
                            </button>
                        {% else %}
                            <button type="submit" class="btn btn-dark w-100 btn-lg rounded-0 text-uppercase fw-bold">
                                Like ({{ artifact.likes_count }})
                            </button>
                        {% endif %}
                    </form>
                    
                    {% if user and user.id != artifact.creator_id %}
                    <form action="/artifacts/{{ artifact.id }}/collect" method="post" class="mt-2">
                        <button type="submit" class="btn btn-outline-dark w-100 btn-lg rounded-0 text-uppercase fw-bold" style="letter-spacing: 1px;">
                            <i class="bi bi-plus-circle me-2"></i> Collect
                        </button>
                    </form>
                    {% endif %}
                    
                    {% if user and user.id == artifact.creator_id %}
                        <form action="/artifacts/{{ artifact.id }}/delete" method="post" onsubmit="return confirm('Are you sure?');" class="mt-2">
                            <button type="submit" class="btn btn-outline-danger w-100 rounded-0 text-uppercase">Delete Artifact</button>
                        </form>
                    {% endif %}
                </div>

                <div class="mt-5 pt-4 border-top">
                    <p class="small text-muted mb-1">Uploaded by <strong>{{ artifact.creator.username }}</strong></p>
                    <p class="small text-muted">{{ artifact.views_count }} views</p>
                    
                    {% if artifact.tags %}
                    <div class="mt-3">
                        {% for tag in artifact.tags.split(',') %}
                            <span class="badge bg-light text-dark border rounded-0">{{ tag.strip() }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- AI Knowledge Expander -->
                <div class="mt-5 p-4 bg-light border rounded-3">
                    <h4 class="fw-bold text-success mb-3">
                        <i class="bi bi-robot"></i> AI Knowledge Expander
                    </h4>
                    <div id="ai-loading" class="text-muted fst-italic">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        Analyzing artifact connections...
                    </div>
                    <div id="ai-content" style="display: none;">
                        <div class="mb-3">
                            <h6 class="fw-bold text-uppercase small text-muted">Historical Connection</h6>
                            <p id="ai-fact" class="mb-0"></p>
                        </div>
                        
                        <div class="mb-3">
                            <h6 class="fw-bold text-uppercase small text-muted">Related Inventions</h6>
                            <ul id="ai-inventions" class="ps-3 mb-0"></ul>
                        </div>

                        <div>
                            <h6 class="fw-bold text-uppercase small text-muted">Similar Artifacts</h6>
                            <ul id="ai-similar" class="list-unstyled mb-0"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const artifactId = {{ artifact.id }};
    
    fetch(`/api/ai/enrich/${artifactId}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('ai-loading').style.display = 'none';
            document.getElementById('ai-content').style.display = 'block';
            
            // Fact
            document.getElementById('ai-fact').innerText = data.ai_analysis.historical_connection;
            
            // Inventions
            const invList = document.getElementById('ai-inventions');
            if (data.ai_analysis.related_inventions) {
                data.ai_analysis.related_inventions.forEach(inv => {
                    const li = document.createElement('li');
                    li.innerText = inv;
                    invList.appendChild(li);
                });
            }
            
            // Similar Artifacts
            const simList = document.getElementById('ai-similar');
            if (data.similar_artifacts && data.similar_artifacts.length > 0) {
                data.similar_artifacts.forEach(sim => {
                    const li = document.createElement('li');
                    li.className = "mb-2";
                    li.innerHTML = `
                        <a href="/artifact/${sim.id}" class="text-decoration-none fw-bold text-dark">
                            ${sim.title}
                        </a>
                        <span class="badge bg-secondary ms-2">${sim.era}</span>
                        <small class="text-muted d-block">${(sim.similarity * 100).toFixed(0)}% Match</small>
                    `;
                    simList.appendChild(li);
                });
            } else {
                simList.innerHTML = '<li class="text-muted small">No similar artifacts found.</li>';
            }
        })
        .catch(err => {
            console.error(err);
            document.getElementById('ai-loading').innerText = "Failed to load AI analysis.";
        });
});
</script>
{% endblock %}
